<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>32f6c7 중복글</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      overscroll-behavior: contain;
      touch-action: manipulation;
    }
    .popup-box {
      resize: none !important;
      overflow: hidden !important;
      min-width: 350px;
      max-width: 95vw;
    }
    .popup-form-row {
      display: flex;
      align-items: center;
      gap: 0.45em;
      margin-bottom: 0.55em;
      width: 100%;
    }
    .popup-form-row label {
      min-width: 27px;
      font-size: 0.99em;
      margin-right: 0.03em;
      white-space: nowrap;
      font-family: 'Freesentation6','Noto Sans KR',sans-serif;
    }
    .popup-form-row input,
    .popup-form-row select {
      font-size: 0.96em;
      font-family: 'Freesentation3','Noto Sans KR',sans-serif;
      padding: 0.35em 0.41em;
      border-radius: 0.7em;
      border: 1.1px solid #cbd3da;
    }
    .popup-form-row input[type="file"] {
      min-width: 90px;
      max-width: 250px;
      font-size: 0.95em;
      padding: 0.31em 0;
    }
    h1, h2, h3, h4, h5, h6, .popup-title, .popup-box label, .badge-sr, .badge-r, .badge-n, .admin-bar .admin-add-btn, .top-bar .admin-btn, .card-btns button {
    input#admin-pw::placeholder {
      font-size: 0.72em;
      color: #aaa !important;
    }
      font-family: 'Freesentation6', 'Freesentation3', 'Noto Sans KR', sans-serif !important;
    }
    .top-title {
      font-family: 'Freesentation6', 'Noto Sans KR', sans-serif !important;
      font-size: 1.17em;
      letter-spacing: -0.01em;
    }
    input, select, button, ::placeholder {
      font-family: 'Freesentation3', 'Noto Sans KR', sans-serif !important;
    }
    button, .top-bar .admin-btn, .admin-bar .admin-add-btn {
      font-family: 'Freesentation6', 'Freesentation3', 'Noto Sans KR', sans-serif !important;
    }
    @font-face {
      font-family: 'Freesentation3';
      src: url('https://vifigigmfjtiuoixzdyj.supabase.co/storage/v1/object/public/fonts/free3.ttf') format('truetype');
      font-display: swap;
    }
    @font-face {
      font-family: 'Freesentation6';
      src: url('https://vifigigmfjtiuoixzdyj.supabase.co/storage/v1/object/public/fonts/free6.ttf') format('truetype');
      font-display: swap;
    }
    html, body, .main {
      max-width: 100vw !important;
      overflow-x: hidden !important;
    }
    body { background: #f5f6fa; font-family: 'Freesentation3', 'Noto Sans KR', sans-serif; margin:0; }
    /* overflow-x: auto/scroll 제거 */
    /* .top-bar, .main 등에서 overflow-x 관련 스타일 없음 확인 */
    .top-bar {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.4em;
      padding: 1.2em 1.2em 0.5em;
      background: #fff;
      border-bottom: 1px solid #f1f3f9;
      /* position: sticky;
      top: 0;
      z-index: 99; */
    }
    .top-bar-filters {
      display: flex;
      gap: 0.6em;
      width: 100%;
      align-items: center;
      justify-content: flex-start;
      /* Vertically and horizontally align children */
    }
    .top-bar input[type=password], .top-bar input[type=text] {
      padding: 0.6em;
      border-radius: 0.7em;
      border: 1px solid #cbd3da;
      font-size: 0.70em;
      height: 2.2em;
      box-sizing: border-box;
      vertical-align: middle;
    }
    .top-bar select {padding:0.5em 0.8em; border-radius:0.7em; border:1.2px solid #dbe1ea; background:#f4f5fb;}
    .top-bar button {padding:0.65em 1.2em; border-radius:0.8em; background:#a6aefc; color:#1a237e; border:none; cursor:pointer;}
    .top-bar .admin-btn {background:#222; color:#fff;}
    #search-keyword {
      flex: 2 1 200px;
      min-width: 130px;
      max-width: 380px;
      font-size: 0.86em;
      border-radius: 0.7em;
      border: 1px solid #cbd3da;
      font-family: 'Freesentation3','Noto Sans KR',sans-serif;
      box-sizing: border-box;
      height: 2.2em;
      padding: 0.6em 0.68em;
      vertical-align: middle;
      display: inline-block;
    }
    #filter-integrated-btn,
    #admin-login-btn,
    .admin-add-btn {
      width: 110px !important;
      min-width: 110px !important;
      max-width: 110px !important;
      font-size: 0.86em;
      border-radius: 0.7em !important;
      padding: 0.6em 0 !important;
      margin: 0 !important;
      font-family: 'Freesentation6','Noto Sans KR',sans-serif;
      box-sizing: border-box;
      height: 2.2em !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
    }
    .admin-add-btn { margin-left: 0.18em !important; }
    @media (max-width: 600px) {
      .top-bar-filters {
        flex-wrap: wrap;
        gap: 0.38em;
        align-items: center;
        justify-content: flex-start;
      }
      #search-keyword {
        min-width: 70px;
        max-width: none;
        font-size: 0.86em;
        border-radius: 0.7em;
        height: 2.2em;
        padding: 0.6em 0.68em;
        vertical-align: middle;
        display: inline-block;
      }
      #filter-integrated-btn,
      #admin-login-btn,
      .admin-add-btn {
        width: 90px !important;
        min-width: 90px !important;
        max-width: 90px !important;
        font-size: 0.86em;
        border-radius: 0.7em !important;
        height: 2.2em !important;
        padding: 0.6em 0 !important;
        vertical-align: middle;
      }
    }
    .main {max-width:1120px; margin:0.7em auto 0; padding:0 1em;}
    .card-list {display:flex; flex-wrap:wrap; gap:1.5em; margin-top:1em; justify-content:center;}
    .item-card { background:#fff !important; border-radius:1.1em; box-shadow:0 2px 10px #0001; padding:0.6em; width:80px; display:flex; flex-direction:column; align-items:center; position:relative;}
    .item-card .item-img {
      width: 100%;
      aspect-ratio: 5/4;
      object-fit: cover;
      border-radius: 0.5em;
      margin-bottom: 0.4em;
      background: #eee;
      display: block;
      box-shadow:0 0 4px #0001;
    }
    .item-card .badge { display:inline-block; font-size:0.98em; padding:0.19em 1.1em; border-radius:0.9em; margin-bottom:0.25em;}
    .item-card .item-title {
      font-size: 0.91em;
      font-weight: 400;
      text-align: center;
      word-break: break-all;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 0.2em 0;
    }
    .badge-sr { background: #fff9d7 !important; color: #a39100 !important; }
    .badge-r { background: #e2f5ff !important; color: #2387b2 !important; }
    .badge-n { background: #ededed !important; color: #666 !important; }
    .badge-qty {
      display: inline-block;
      background: #eceff5;
      color: #263256;
      border-radius: 50%;
      font-size: 0.79em;
      padding: 0.06em 0.65em 0.04em 0.65em;
      vertical-align: middle;
      margin-right: 0;
      margin-left: 0.17em;
      font-family: 'Freesentation6','Noto Sans KR',sans-serif;
      font-weight: bold;
      min-width: 2.1em;
      text-align: center;
      line-height: 1.15;
    }
    .item-card .card-btns {display:flex; gap:0.5em;}
    .item-card .edit-btn, .item-card .del-btn { border:none; background:#ececec; border-radius:0.7em; padding:0.3em 0.95em; font-size:0.85em; cursor:pointer;}
    .item-card .edit-btn {background:#a6f1b7; color:#18713a;}
    .item-card .del-btn {background:#ffcccc; color:#ae2323;}
    .admin-bar {display:none; justify-content:space-between; align-items:center; background:#fafbff; border-radius:1em; margin:1.5em 0 0.8em; padding:1.1em 2.5em 1em;}
    .admin-bar.active {display:flex;}
    .admin-bar .filter-group {display:flex; gap:0.8em;}
    .admin-bar .admin-add-btn {background:#ffe066; color:#765c01;}
    /* 팝업 및 필터 팝업 */
    .popup-bg,
    #filter-popup-bg {
      display: none;
      position: fixed;
      z-index: 200 !important;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: #2227;
    }
    .popup-box,
    #filter-popup-box {
      display: none;
      position: fixed;
      z-index: 210 !important;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 1.3em;
      box-shadow: 0 4px 24px #0004;
      padding: 2.2em 2em 1.2em;
      min-width: 320px;
      max-width: 90vw;
    }
    .popup-box label {
      display: block;
      margin-top: 0.65em;
      font-size: 0.94em;
    }
    .popup-box input,
    .popup-box select,
    .popup-box .popup-save,
    .popup-box .popup-cancel {
      font-size: 0.94em;
    }
    .popup-box input, .popup-box select {width:100%;margin:0.45em 0 0.2em;padding:0.7em 0.9em;border-radius:0.8em;border:1.1px solid #cbd3da;box-sizing:border-box;}
    .popup-box .popup-btns{margin-top:1.5em;text-align:center;}
    .popup-box button{padding:0.6em 1.3em;border-radius:0.8em;border:none;cursor:pointer;}
    .popup-box .popup-save{background:#a6f1b7;color:#18713a;margin-right:0.8em;}
    .popup-box .popup-cancel{background:#ececec;color:#7d7d7d;}
    /* 모바일 2열 */
    @media (max-width: 640px) {
      .main {padding:0;}
      .card-list {gap:0.5em;}
      .item-card {width: 25%;}
      .admin-bar {padding:1em 0.8em;}
    }
    /* category-tabs */
    .category-tabs {
      margin-top: 0.6em;
      margin-bottom: 0.2em;
      display: flex;
      gap: 0.5em;
      overflow-x: auto;
      padding-bottom: 0.3em;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      background: none !important;
      overscroll-behavior-x: contain;
      scroll-behavior: smooth;
      width: 100vw;
      overflow-x: auto !important;
    }
    .category-tabs::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      background: none !important;
    }

    .cat-btn {
      border: none;
      background: transparent !important;
      cursor: pointer;
      padding: 0.15em 0.3em;
      border-radius: 0.6em;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      width: 34px;
      height: 34px;
      box-shadow: 0 2px 7px 0 #bbb2;
      transition: box-shadow 0.2s;
      margin: 0 !important;
    }
    .cat-btn img {
      width: 24px;
      height: 24px;
      display: block;
      pointer-events: none;
      user-select: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
<body style="overflow-x:hidden;overflow-y:auto; overscroll-behavior: contain; touch-action: manipulation;">
  <!-- 상단 로그인/필터 -->
  <div class="top-bar">
    <div style="display:flex;align-items:center;gap:0.9em;">
      <span class="top-title">32f6c7 중복글</span>
      <input id="admin-pw" type="text" placeholder="비밀번호" style="width:170px;font-size:0.70em;">
      <button id="admin-login-btn" class="admin-btn">관리자모드</button>
      <!-- <span id="last-modified-info" style="color:#616161; font-size:0.70em; margin-left:0.95em;"></span> -->
    </div>
    <div class="top-bar-filters">
      <input id="search-keyword" type="text" placeholder="템 이름 검색">
      <button id="filter-integrated-btn" style="background:#e2e8fc; color:#1a237e;">통합 필터</button>
      <span id="filter-selected-count" style="font-size:0.70em; color:#5c5c5c; margin-left:0.7em;"></span>
    </div>
    <div class="category-tabs" id="category-tabs"></div>
    <script>
    function updateSearchKeywordStyleForAdminMode(isAdminNow) {
      if (!searchKeyword) return;
      if (isAdminNow) {
        searchKeyword.style.maxWidth = "135px";
        searchKeyword.style.fontSize = "0.70em";
        searchKeyword.style.height = "2em";
        searchKeyword.style.padding = "0.34em 0.68em";
        searchKeyword.style.minWidth = "";
      } else {
        searchKeyword.style.minWidth = "220px";
        searchKeyword.style.fontSize = "0.70em";
        searchKeyword.style.height = "2em";
        searchKeyword.style.padding = "0.34em 0.68em";
        searchKeyword.style.maxWidth = "";
      }
    }
    </script>
    <div class="category-tabs" id="category-tabs"></div>
  </div>
  <div class="main">
    <div class="card-list" id="card-list"></div>
  </div>
  <!-- 팝업 (추가/수정) -->
  <div class="popup-bg" id="popup-bg"></div>
  <div class="popup-box" id="popup-box">
    <form id="popup-form" autocomplete="off">
      <h2 id="popup-title" style="margin:0 0 0.45em 0;font-size:1.11em;"></h2>

      <div class="popup-form-row">
        <label>이름</label>
        <input id="form-title" required style="flex:2; min-width:130px;">
      </div>
      <div class="popup-form-row" style="gap:0.38em;">
        <label>수량</label>
        <input id="form-qty" type="number" min="0" required style="max-width:60px;">
        <label>등급</label>
        <select id="form-grade" required style="max-width:54px;">
          <option value="">-</option>
          <option value="SR">SR</option>
          <option value="R">R</option>
          <option value="N">N</option>
        </select>
        <label>카테고리</label>
        <select id="form-category" required style="max-width:68px;">
          <option value="">카테고리 선택</option>
          <option>헤어</option>
          <option>팬티</option>
          <option>상하의</option>
          <option>남옷</option>
          <option>여옷</option>
          <option>겉옷</option>
          <option>타이츠</option>
          <option>신발</option>
          <option>모자</option>
          <option>리본</option>
          <option>안경</option>
          <option>왼손</option>
          <option>오른손</option>
          <option>몸통</option>
          <option>아우라</option>
          <option>눈</option>
          <option>눈썹</option>
          <option>코</option>
          <option>입</option>
        </select>
      </div>
      <div class="popup-form-row">
        <label>출시</label>
        <input id="form-date" type="date" required style="max-width:86px;">
        <label style="margin-left:0.8em;">분류</label>
        <input id="form-theme01" required style="max-width:75px;">
      </div>
      <div class="popup-form-row">
        <label>테마명</label>
        <input id="form-theme02" style="flex:2; min-width:150px;">
      </div>
      <div class="popup-form-row">
        <label>썸네일</label>
        <input id="form-img" type="file" accept="image/*" style="flex:2; min-width:170px;">
      </div>
      <div class="popup-btns" style="margin-top:1.1em;">
        <button type="submit" class="popup-save">저장</button>
        <button type="button" class="popup-cancel" id="popup-cancel">취소</button>
      </div>
    </form>
  </div>
  <script>
    const categoryList = [
      { name: "", icon: { ac: "ac_all.png", de: "de_all.png" } },
      { name: "헤어", icon: { ac: "ac_hair.png", de: "de_hair.png" } },
      { name: "팬티", icon: { ac: "ac_pants.png", de: "de_pants.png" } },
      { name: "상하의", icon: { ac: "ac_clothes.png", de: "de_clothes.png" } },
      { name: "남옷", icon: { ac: "ac_boy.png", de: "de_boy.png" } },
      { name: "여옷", icon: { ac: "ac_girl.png", de: "de_girl.png" } },
      { name: "겉옷", icon: { ac: "ac_outer.png", de: "de_outer.png" } },
      { name: "타이츠", icon: { ac: "ac_ti.png", de: "de_ti.png" } },
      { name: "신발", icon: { ac: "ac_shoes.png", de: "de_shoes.png" } },
      { name: "모자", icon: { ac: "ac_hat.png", de: "de_hat.png" } },
      { name: "리본", icon: { ac: "ac_ribbon.png", de: "de_ribbon.png" } },
      { name: "안경", icon: { ac: "ac_glasses.png", de: "de_glasses.png" } },
      { name: "왼손", icon: { ac: "ac_left.png", de: "de_left.png" } },
      { name: "오른손", icon: { ac: "ac_right.png", de: "de_right.png" } },
      { name: "몸통", icon: { ac: "ac_body.png", de: "de_body.png" } },
      { name: "아우라", icon: { ac: "ac_aura.png", de: "de_aura.png" } },
      { name: "눈", icon: { ac: "ac_eye.png", de: "de_eye.png" } },
      { name: "눈썹", icon: { ac: "ac_br.png", de: "de_br.png" } },
      { name: "코", icon: { ac: "ac_nose.png", de: "de_nose.png" } },
      { name: "입", icon: { ac: "ac_lip.png", de: "de_lip.png" } }
    ];
    const CATEGORY_ICON_BASE = "https://vifigigmfjtiuoixzdyj.supabase.co/storage/v1/object/public/category-icons/";
    let selectedCategory = "";

    // Supabase 설정
    const SUPABASE_URL = "https://vifigigmfjtiuoixzdyj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZmlnaWdtZmp0aXVvaXh6ZHlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNTAyMzcsImV4cCI6MjA2ODkyNjIzN30.ZSq1WJWaSSqQF1dhX2QtDAJ2il4-MmRaHac21l_JYAU";
    const BUCKET = "item-images";
    const TABLE = "items";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 상태 변수 ---
    let isAdmin = false;
    let allItems = [];
    let adminEditId = null;

    // --- UI 이벤트 바인딩 ---
    // const adminId = document.getElementById("admin-id"); // removed
    const adminPw = document.getElementById("admin-pw");
    const adminLoginBtn = document.getElementById("admin-login-btn");
    const adminBar = document.getElementById("admin-bar");
    const cardList = document.getElementById("card-list");
    const searchKeyword = document.getElementById("search-keyword");
    // 통합 필터 버튼 및 선택 카운트
    const filterIntegratedBtn = document.getElementById("filter-integrated-btn");
    const filterSelectedCount = document.getElementById("filter-selected-count");

    // --- 로그인/권한 로직 ---
    // 관리자모드 토글 (중복 정의 제거, adminBar 관련 제거)
    adminLoginBtn.onclick = () => {
      if (isAdmin) {
        isAdmin = false;
        adminLoginBtn.textContent = "관리자모드";
        updateSearchKeywordStyleForAdminMode(false); // 관리자모드 해제 시 스타일 원복
        // 버튼 제거 (관리자모드 해제 시)
        const btn = document.getElementById('admin-add-btn');
        if (btn && btn.parentNode && btn.parentNode.classList.contains('top-bar-filters')) {
          btn.parentNode.removeChild(btn);
        }
        loadItems();
        return;
      }
      // 아이디는 "32f6c7"로 고정
      if (adminPw.value === "wjddufo1!") {
        isAdmin = true;
        adminLoginBtn.textContent = "관리자모드 해제";
        updateSearchKeywordStyleForAdminMode(true); // 관리자모드 진입 시 스타일 적용
        ensureAdminAddBtn();
        loadItems();
      } else {
        alert("비밀번호가 틀렸습니다.");
      }
    };

    // --- 데이터 불러오기/필터 ---
    async function loadItems() {
      let { data, error } = await supabase.from(TABLE).select("*").order("date", { ascending: false });
      if (error) { cardList.innerHTML = "불러오기 실패: " + error.message; return; }
      allItems = data;
      setFilters();
      renderCategoryTabs();
      drawCards();
      showLastModified();
    }

    // -------- 통합 필터 상태 및 팝업 --------
    // 필터 상태
    let integratedFilter = {
      years: [],
      themes: [],      // theme01 (테마분류)
      themes2: [],     // theme02 (테마명)
      themeKeyword: "", // theme02 검색어
    };
    // 연도/테마 전체 목록
    let allYears = [];
    let allThemes = [];
    let allThemes2 = [];

    function setFilters() {
      // 통합 필터용 전체 목록 저장 (연도는 2015~2025 고정)
      const years = [...new Set(allItems.map(x=>x.date?x.date.substr(0,4):"").filter(x=>x))];
      const themes = [...new Set(allItems.map(x=>x.theme01).filter(x=>x))];
      const themes2 = [...new Set(allItems.map(x=>x.theme02).filter(x=>x))];
      allYears = [];
      for (let y = 2015; y <= 2025; ++y) allYears.push(String(y));
      allThemes = themes.slice();
      allThemes2 = themes2.slice();
      updateFilterSelectedCount();
    }

    function renderCategoryTabs() {
      const el = document.getElementById('category-tabs');
      el.innerHTML = "";
      categoryList.forEach(cat => {
        const btn = document.createElement("button");
        btn.className = "cat-btn" + (selectedCategory === cat.name ? " selected" : "");
        btn.setAttribute("data-cat", cat.name);
        btn.innerHTML = `<img src="${CATEGORY_ICON_BASE + (selectedCategory === cat.name ? cat.icon.ac : cat.icon.de)}" alt="${cat.name || "전체"}">`;
        btn.onclick = () => {
          selectedCategory = cat.name;
          renderCategoryTabs();
          drawCards();
        };
        el.appendChild(btn);
      });
    }

    // --- 카드 목록 그리기 ---
    function drawCards() {
      // 템 이름 검색(상단 input) 필터는 항상 적용
      const keyword = searchKeyword.value.trim();
      let items = allItems;
      // 통합 필터 (상단 통합 필터만 사용)
      if (integratedFilter.years.length > 0) {
        items = items.filter(x => x.date && integratedFilter.years.includes(x.date.substr(0, 4)));
      }
      if (integratedFilter.themes.length > 0) {
        items = items.filter(x => x.theme01 && integratedFilter.themes.includes(x.theme01));
      }
      if (integratedFilter.themes2 && integratedFilter.themes2.length > 0) {
        items = items.filter(x => x.theme02 && integratedFilter.themes2.includes(x.theme02));
      }
      if (integratedFilter.themeKeyword && integratedFilter.themeKeyword.trim().length > 0) {
        items = items.filter(x => x.theme02 && x.theme02.includes(integratedFilter.themeKeyword));
      }
      // 템 이름 검색
      if (keyword) items = items.filter(x=>x.title && x.title.includes(keyword));
      // 카테고리 탭 필터
      if (selectedCategory) items = items.filter(x=>x.category === selectedCategory);

      cardList.innerHTML = "";
      if (!items.length) {
        cardList.innerHTML = `<div style="text-align:center;margin:3em 0;color:#888;">아이템이 없습니다.</div>`;
        return;
      }
      items.forEach(item => {
        const badgeClass = item.grade === "SR" ? "badge-sr" : item.grade === "R" ? "badge-r" : "badge-n";
        // 이름/수량 인라인, 등급 배지는 아래 한 줄
        cardList.innerHTML += `
          <div class="item-card">
            <img class="item-img" src="${item.thumbnail||''}" alt="썸네일">
            <div class="item-title-inline">
              <span class="item-title-text">${item.title||''}</span>
              <span class="badge-qty">${item.quantity||''}</span>
            </div>
            <span class="badge ${badgeClass}" style="font-size:0.81em;min-width:2.4em;text-align:center;margin-top:0.33em;display:inline-block;">${item.grade||''}</span>
            ${isAdmin ? `
            <div class="card-btns">
              <button class="edit-btn" data-id="${item.id}">수정</button>
              <button class="del-btn" data-id="${item.id}">삭제</button>
            </div>` : ""}
          </div>
        `;
      });
    }

    // --- 카드 필터 이벤트 ---
    searchKeyword.oninput = drawCards;
    // ----------- 통합 필터 팝업 UI -----------
    // 팝업 배경/박스 생성 (스타일은 popup-bg/popup-box와 동일하게)
    let filterPopupBg = document.createElement('div');
    filterPopupBg.id = "filter-popup-bg";
    filterPopupBg.className = "popup-bg";
    filterPopupBg.style.display = "none";
    document.body.appendChild(filterPopupBg);
    let filterPopupBox = document.createElement('div');
    filterPopupBox.id = "filter-popup-box";
    filterPopupBox.className = "popup-box";
    filterPopupBox.style.display = "none";
    document.body.appendChild(filterPopupBox);

    // 팝업 열기
    filterIntegratedBtn.onclick = function() {
      renderFilterPopup();
      filterPopupBg.style.display = filterPopupBox.style.display = "block";
      // 포커스 테마명 검색 input
      setTimeout(() => {
        let inp = document.getElementById("filter-popup-theme-search");
        if (inp) inp.focus();
      }, 80);
    };
    // 팝업 닫기
    filterPopupBg.onclick = function() {
      filterPopupBg.style.display = filterPopupBox.style.display = "none";
    };

    // --- 테마명 검색 임시 버퍼 ---
    let themeKeywordBuffer = "";

    function renderFilterPopup() {
      // (1) themeKeywordBuffer 동기화
      if (typeof themeKeywordBuffer !== "string") themeKeywordBuffer = "";
      if (themeKeywordBuffer === "" && integratedFilter.themeKeyword)
        themeKeywordBuffer = integratedFilter.themeKeyword;

      // 스타일 삽입 (한 번만)
      if (!document.getElementById('filter-chip-style')) {
        const style = document.createElement('style');
        style.id = 'filter-chip-style';
        style.textContent = `
        .filter-chip {
          display: inline-block;
          border: none;
          outline: none;
          cursor: pointer;
          border-radius: 0.7em;
          font-size: 1em;
          font-family: 'Freesentation6', 'Noto Sans KR', sans-serif;
          padding: 0.2em 0.8em;
          margin: 0 0.22em 0.22em 0;
          background: #f5f6fa;
          color: #24304b;
          font-weight: 400;
          transition: background 0.15s, font-weight 0.15s;
          min-width: 2.2em;
        }
        .filter-chip.selected {
          background: #e2e8fc !important;
          color: #1a237e !important;
          font-weight: bold !important;
          font-family: 'Freesentation6', 'Noto Sans KR', sans-serif !important;
        }
        .filter-chip:active {
          background: #c8d7fa;
        }
        .filter-chip.filter-popup-year {
          padding: 0.22em 0.9em;
        }
        .filter-chip.filter-popup-theme {
          padding: 0.22em 0.9em;
        }
        .filter-chip.filter-popup-theme2 {
          padding: 0.22em 0.9em;
        }
        `;
        document.head.appendChild(style);
      }
      // 팝업 HTML
      filterPopupBox.innerHTML = `
        <h2 class="popup-title" style="margin:0 0 1em;font-size:1.13em;">통합 필터</h2>
        <div>
          <label style="margin-bottom:0.2em;font-size:1em;">연도</label>
          <div style="max-height:120px;overflow-y:auto;border:1px solid #e3e6ef;border-radius:0.8em;padding:0.7em 0.5em 0.7em 0.5em;display:flex;flex-wrap:wrap;gap:0.13em 0.1em;">
            ${allYears.map(y=>`
              <button type="button"
                class="filter-chip filter-popup-year${integratedFilter.years.includes(y) ? " selected" : ""}"
                data-value="${y}"
                style="${integratedFilter.years.includes(y)
                  ? 'background:#e2e8fc;color:#1a237e;font-weight:bold;font-family:Freesentation6, Noto Sans KR, sans-serif;'
                  : 'background:#f5f6fa;color:#24304b;font-weight:400;font-family:Freesentation6, Noto Sans KR, sans-serif;'}"
              >${y}</button>
            `).join("")}
          </div>
        </div>
        <!-- 테마 chips (theme01) -->
        <div style="margin-top:1.3em;">
          <label style="margin-bottom:0.2em;font-size:1em;">테마분류</label>
          <div id="filter-popup-theme01-list" style="max-height:140px;overflow-y:auto;border:1px solid #e3e6ef;border-radius:0.8em;padding:0.7em 0.5em 0.7em 0.5em;display:flex;flex-wrap:wrap;gap:0.13em 0.1em;">
            ${
              allThemes.map(t=>`
                <button type="button"
                  class="filter-chip filter-popup-theme${integratedFilter.themes.includes(t) ? " selected" : ""}"
                  data-value="${t.replace(/"/g,'&quot;')}"
                >${t}</button>
              `).join("")
            }
          </div>
        </div>
        <!-- 테마명 chips (theme02) + 검색 -->
        <div style="margin-top:1.3em;">
          <label style="margin-bottom:0.2em;font-size:1em;">테마명</label>
          <div style="display:flex;gap:0.6em;align-items:center;">
            <input id="filter-popup-theme2-search" type="text" placeholder="테마명 입력" style="flex:1;" value="${themeKeywordBuffer.replace(/"/g,'&quot;')}">
            <button id="filter-popup-theme2-search-btn" type="button" style="padding:0.52em 1.2em;border-radius:0.7em;background:#a6aefc;color:#1a237e;border:none;cursor:pointer;font-size:0.96em;font-family:'Freesentation6','Noto Sans KR',sans-serif;">검색</button>
          </div>
          <div id="theme2-list-container" style="display:none;">
            <div id="filter-popup-theme2-list" style="margin-top:0.5em;max-height:140px;overflow-y:auto;border:1px solid #e3e6ef;border-radius:0.8em;padding:0.7em 0.5em 0.7em 0.5em;display:flex;flex-wrap:wrap;gap:0.13em 0.1em;">
              ${
                (
                  (integratedFilter.themeKeyword && integratedFilter.themeKeyword.trim().length > 0)
                    ? allThemes2.filter(t2=>t2 && t2.includes(integratedFilter.themeKeyword))
                    : allThemes2
                ).map(t2=>`
                  <button type="button"
                    class="filter-chip filter-popup-theme2${integratedFilter.themes2 && integratedFilter.themes2.includes(t2) ? " selected" : ""}"
                    data-value="${t2.replace(/"/g,'&quot;')}"
                  >${t2}</button>
                `).join("")
              }
            </div>
          </div>
        </div>
        <div class="popup-btns" style="margin-top:2em;text-align:center;">
          <button id="filter-popup-apply" class="popup-save" style="background:#a6aefc;color:#1a237e;margin-right:0.7em;">필터 적용</button>
          <button id="filter-popup-reset" class="popup-cancel" style="background:#ececec;color:#7d7d7d;">초기화</button>
        </div>
      `;
      // 이벤트 바인딩: 연도 버튼
      filterPopupBox.querySelectorAll(".filter-popup-year").forEach(btn=>{
        btn.onclick = function() {
          const val = btn.getAttribute("data-value");
          const idx = integratedFilter.years.indexOf(val);
          if (idx === -1) {
            integratedFilter.years.push(val);
            btn.classList.add("selected");
          } else {
            integratedFilter.years.splice(idx, 1);
            btn.classList.remove("selected");
          }
          renderFilterPopup();
          updateFilterSelectedCount();
        };
      });
      // 이벤트 바인딩: 테마 chips (theme01)
      filterPopupBox.querySelectorAll(".filter-popup-theme").forEach(btn=>{
        btn.onclick = function() {
          const val = btn.getAttribute("data-value");
          const idx = integratedFilter.themes.indexOf(val);
          if (idx === -1) {
            integratedFilter.themes.push(val);
            btn.classList.add("selected");
          } else {
            integratedFilter.themes.splice(idx, 1);
            btn.classList.remove("selected");
          }
          renderFilterPopup();
          updateFilterSelectedCount();
        };
      });
      // (2) 테마명(theme02) chips
      // chips는 검색 버튼이 눌러져야만 보이므로, chips 이벤트는 chips가 그려질 때만 바인딩
      const theme2ListContainer = filterPopupBox.querySelector("#theme2-list-container");
      const theme2SearchInput = filterPopupBox.querySelector('#filter-popup-theme2-search');
      const theme2SearchBtn = filterPopupBox.querySelector('#filter-popup-theme2-search-btn');
      // chips 영역 숨김/노출 제어
      let showTheme2Chips = false;
      // chips 컨테이너를 항상 숨김으로 시작
      theme2ListContainer.style.display = "none";
      // chips 표시 함수
      function showTheme2ChipsList() {
        theme2ListContainer.style.display = "block";
        // chips 클릭 이벤트 바인딩
        filterPopupBox.querySelectorAll(".filter-popup-theme2").forEach(btn=>{
          btn.onclick = function() {
            const val = btn.getAttribute("data-value");
            if (!integratedFilter.themes2) integratedFilter.themes2 = [];
            const idx = integratedFilter.themes2.indexOf(val);
            if (idx === -1) {
              integratedFilter.themes2.push(val);
              btn.classList.add("selected");
            } else {
              integratedFilter.themes2.splice(idx, 1);
              btn.classList.remove("selected");
            }
            renderFilterPopup();
            // chips가 다시 그려졌으므로, 다시 표시
            setTimeout(() => {
              const theme2ListContainerNew = document.getElementById("theme2-list-container");
              if (theme2ListContainerNew) theme2ListContainerNew.style.display = "block";
            }, 0);
            updateFilterSelectedCount();
          };
        });
      }
      // 검색 버튼 클릭 시 chips 노출
      theme2SearchBtn.onclick = function() {
        integratedFilter.themeKeyword = themeKeywordBuffer;
        renderFilterPopup();
        setTimeout(() => {
          const theme2ListContainerNew = document.getElementById("theme2-list-container");
          if (theme2ListContainerNew) theme2ListContainerNew.style.display = "block";
          // 바인딩
          filterPopupBox.querySelectorAll(".filter-popup-theme2").forEach(btn=>{
            btn.onclick = function() {
              const val = btn.getAttribute("data-value");
              if (!integratedFilter.themes2) integratedFilter.themes2 = [];
              const idx = integratedFilter.themes2.indexOf(val);
              if (idx === -1) {
                integratedFilter.themes2.push(val);
                btn.classList.add("selected");
              } else {
                integratedFilter.themes2.splice(idx, 1);
                btn.classList.remove("selected");
              }
              renderFilterPopup();
              setTimeout(() => {
                const theme2ListContainerNew2 = document.getElementById("theme2-list-container");
                if (theme2ListContainerNew2) theme2ListContainerNew2.style.display = "block";
              }, 0);
              updateFilterSelectedCount();
            };
          });
        }, 0);
      };
      // 엔터도 검색과 동일하게 동작
      theme2SearchInput.onkeydown = function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          integratedFilter.themeKeyword = themeKeywordBuffer;
          renderFilterPopup();
          setTimeout(() => {
            const theme2ListContainerNew = document.getElementById("theme2-list-container");
            if (theme2ListContainerNew) theme2ListContainerNew.style.display = "block";
            filterPopupBox.querySelectorAll(".filter-popup-theme2").forEach(btn=>{
              btn.onclick = function() {
                const val = btn.getAttribute("data-value");
                if (!integratedFilter.themes2) integratedFilter.themes2 = [];
                const idx = integratedFilter.themes2.indexOf(val);
                if (idx === -1) {
                  integratedFilter.themes2.push(val);
                  btn.classList.add("selected");
                } else {
                  integratedFilter.themes2.splice(idx, 1);
                  btn.classList.remove("selected");
                }
                renderFilterPopup();
                setTimeout(() => {
                  const theme2ListContainerNew2 = document.getElementById("theme2-list-container");
                  if (theme2ListContainerNew2) theme2ListContainerNew2.style.display = "block";
                }, 0);
                updateFilterSelectedCount();
              };
            });
          }, 0);
        }
      };
      // 입력값 변경 시 chips 숨김
      theme2SearchInput.oninput = function(e) {
        themeKeywordBuffer = e.target.value;
        const theme2ListContainerNew = document.getElementById("theme2-list-container");
        if (theme2ListContainerNew) theme2ListContainerNew.style.display = "none";
      };
      // 필터 적용
      document.getElementById("filter-popup-apply").onclick = function(e) {
        e.preventDefault();
        filterPopupBg.style.display = filterPopupBox.style.display = "none";
        updateFilterSelectedCount();
        drawCards();
      };
      // 초기화
      document.getElementById("filter-popup-reset").onclick = function(e) {
        e.preventDefault();
        integratedFilter.years = [];
        integratedFilter.themes = [];
        integratedFilter.themes2 = [];
        integratedFilter.themeKeyword = "";
        themeKeywordBuffer = "";
        renderFilterPopup();
        updateFilterSelectedCount();
      };
      updateFilterSelectedCount();
    }

    function updateFilterSelectedCount() {
      let txt = [];
      if (integratedFilter.years.length>0) txt.push(`연도 ${integratedFilter.years.length}개`);
      if (integratedFilter.themes.length>0) txt.push(`테마분류 ${integratedFilter.themes.length}개`);
      if (integratedFilter.themes2 && integratedFilter.themes2.length>0) txt.push(`테마명 ${integratedFilter.themes2.length}개`);
      if (integratedFilter.themeKeyword && integratedFilter.themeKeyword.trim().length>0) txt.push(`테마명 "${integratedFilter.themeKeyword}"`);
      filterSelectedCount.textContent = txt.length ? txt.join(", ") : "";
    }

    // --- 카드 수정/삭제 ---
    cardList.onclick = e => {
      const editBtn = e.target.closest(".edit-btn");
      const delBtn = e.target.closest(".del-btn");
      if (editBtn) {
        const id = editBtn.dataset.id;
        openPopup("수정", allItems.find(x=>x.id==id));
      }
      if (delBtn) {
        const id = delBtn.dataset.id;
        if (confirm("정말 삭제할까요?")) deleteItem(id);
      }
    };

    async function deleteItem(id) {
      await supabase.from(TABLE).delete().eq("id", id);
      loadItems();
    }

    // --- 아이템 추가/수정 팝업 ---
    const popupBg = document.getElementById("popup-bg");
    const popupBox = document.getElementById("popup-box");
    const popupForm = document.getElementById("popup-form");
    const popupTitle = document.getElementById("popup-title");
    const formTitle = document.getElementById("form-title");
    const formQty = document.getElementById("form-qty");
    const formGrade = document.getElementById("form-grade");
    const formCategory = document.getElementById("form-category");
    const formImg = document.getElementById("form-img");
    const formDate = document.getElementById("form-date");
    const formTheme01 = document.getElementById("form-theme01");
    const formTheme02 = document.getElementById("form-theme02");

    // 아이템 추가 버튼을 .top-bar-filters에 append (중복 방지)
    function ensureAdminAddBtn() {
      if (!document.getElementById('admin-add-btn')) {
        const btn = document.createElement('button');
        btn.className = "admin-add-btn";
        btn.id = "admin-add-btn";
        btn.textContent = "아이템 추가하기";
        btn.onclick = () => openPopup("추가");
        document.querySelector('.top-bar-filters').appendChild(btn);
      }
    }
    // 관리자모드 진입 시 버튼 이동/생성
    const origAdminAddBtn = document.getElementById('admin-add-btn');
    if (origAdminAddBtn && origAdminAddBtn.parentNode && origAdminAddBtn.parentNode.classList.contains('admin-bar')) {
      origAdminAddBtn.parentNode.removeChild(origAdminAddBtn);
    }
    // 최초 진입 시, 관리자모드 진입 때마다 호출 필요. (아래에서 호출)

    // 팝업 열기/닫기
    document.getElementById("popup-cancel").onclick = closePopup;
    function openPopup(mode, item) {
      popupBg.style.display = popupBox.style.display = "block";
      document.body.style.overflow = "hidden";
      popupTitle.textContent = mode === "수정" ? "아이템 수정" : "아이템 추가";
      formTitle.value = item?.title || "";
      formQty.value = item?.quantity || "";
      formGrade.value = item?.grade || "";
      formCategory.value = item?.category || "";
      formImg.value = "";
      formDate.value = item?.date || "";
      formTheme01.value = item?.theme01 || "";
      formTheme02.value = item?.theme02 || "";
      adminEditId = mode === "수정" ? item.id : null;
    }
    function closePopup() {
      popupBg.style.display = popupBox.style.display = "none";
      document.body.style.overflow = "";
      popupForm.reset();
      adminEditId = null;
    }
    popupBg.onclick = closePopup;

    popupForm.onsubmit = async e => {
      e.preventDefault();
      // 필드 읽기
      const title = formTitle.value.trim();
      const quantity = Number(formQty.value);
      const grade = formGrade.value;
      const category = formCategory.value;
      const date = formDate.value;
      const theme01 = formTheme01.value.trim();
      const theme02 = formTheme02.value.trim();
      let thumbnail = null;
      if (formImg.files.length) {
        // 업로드
        const file = formImg.files[0];
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).slice(2)}.${fileExt}`;
        const { error } = await supabase.storage.from(BUCKET).upload(fileName, file, { upsert: true });
        if (error) return alert("이미지 업로드 실패: "+error.message);
        thumbnail = supabase.storage.from(BUCKET).getPublicUrl(fileName).data.publicUrl;
      }
      if (adminEditId) {
        // 수정
        const updateObj = { title, quantity, grade, category, date, theme01, theme02 };
        if (thumbnail) updateObj.thumbnail = thumbnail;
        await supabase.from(TABLE).update(updateObj).eq("id", adminEditId);
        closePopup(); loadItems();
      } else {
        if (!thumbnail) return alert("이미지는 첨부 필수!");
        await supabase.from(TABLE).insert([{ title, quantity, grade, category, thumbnail, date, theme01, theme02 }]);
        closePopup(); loadItems();
      }
    };

    // 카테고리 탭 가로 스크롤시 전체 페이지에 가로 스크롤 전파 안 되도록!
    document.getElementById('category-tabs').addEventListener('wheel', function(e){
      if (e.deltaX !== 0) e.stopPropagation();
    }, {passive:true});
    document.getElementById('category-tabs').addEventListener('touchmove', function(e){
      e.stopPropagation();
    }, {passive:true});
    // --- 최초 렌더 ---
    loadItems();

    // ---- 기존 연도/테마 select 완전 제거 (top-bar) ----
    // (실제 DOM에서 select#filter-year, select#filter-theme01 삭제)
    window.addEventListener('DOMContentLoaded', ()=>{
      let fy = document.getElementById('filter-year');
      if (fy) fy.parentNode.removeChild(fy);
      let ft = document.getElementById('filter-theme01');
      if (ft) ft.parentNode.removeChild(ft);
    });

    // --- 관리자모드 진입 시 .top-bar-filters에 버튼 append
    // (adminLoginBtn.onclick은 위에서 한 번만 정의, adminBar 관련 코드 제거)

    async function showLastModified() {
      const { data, error } = await supabase.from('items_log').select('at').order('at', { ascending: false }).limit(1);
      const pwInput = document.getElementById('admin-pw');
      if (error || !data?.length) {
        if (pwInput) pwInput.placeholder = "마지막 수정: -";
        return;
      }
      const last = new Date(data[0].at);
      let s = `${last.getFullYear()}. ${String(last.getMonth()+1).padStart(2,"0")}. ${String(last.getDate()).padStart(2,"0")}. ${String(last.getHours()).padStart(2,"0")}:${String(last.getMinutes()).padStart(2,"0")}`;
      if (pwInput) pwInput.placeholder = `마지막 수정: ${s}`;
    }
    // 페이지 로드 후, 이미 isAdmin인 경우(새로고침 등) 스타일 반영
    window.addEventListener('DOMContentLoaded', function() {
      updateSearchKeywordStyleForAdminMode(isAdmin);
    });
  </script>
</body>
</html>